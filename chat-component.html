<!-- Floating chat button -->
<div id="chatbot-container" style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;">
    <button id="chatbot-toggle" style="background: #4f46e5; color: white; border: none; border-radius: 50%; width: 60px; height: 60px; font-size: 24px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
        ðŸ’¬
    </button>
</div>

<!-- Chat interface -->
<div id="chatbot-interface" style="display: none; position: fixed; bottom: 90px; right: 20px; width: 400px; height: 500px; background: white; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); flex-direction: column; z-index: 1000; border: 1px solid #e5e7eb;">
    <div style="background: #4f46e5; color: white; padding: 15px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
        <h3 style="margin: 0;">Book Assistant</h3>
        <button id="chatbot-close" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer;">Ã—</button>
    </div>
    <div id="chat-messages" style="flex: 1; padding: 15px; overflow-y: auto; background: #f9fafb;">
        <div class="message bot-message">
            <p>Hello! I'm your Physical AI Humanoid Robotics book assistant. Ask me anything about the book content!</p>
        </div>
    </div>
    <div style="padding: 15px; border-top: 1px solid #e5e7eb; background: white; border-radius: 0 0 12px 12px;">
        <div style="display: flex; gap: 10px;">
            <input type="text" id="chat-input" placeholder="Ask about the book..." style="flex: 1; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
            <button id="chat-send" style="background: #4f46e5; color: white; border: none; border-radius: 8px; padding: 12px 20px; cursor: pointer;">Send</button>
        </div>
    </div>
</div>

<!-- Selected text tooltip -->
<div id="selected-text-tooltip" style="display: none; position: absolute; background: #4f46e5; color: white; padding: 8px 12px; border-radius: 6px; font-size: 14px; z-index: 1001; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer;">
    ðŸ’¬ Ask about this
</div>

<style>
.message {
    margin-bottom: 15px;
    max-width: 80%;
}

.user-message {
    margin-left: auto;
    text-align: right;
}

.bot-message {
    margin-right: auto;
}

.user-message p, .bot-message p {
    margin: 0;
    padding: 10px 15px;
    border-radius: 18px;
    display: inline-block;
}

.user-message p {
    background: #4f46e5;
    color: white;
}

.bot-message p {
    background: #e5e7eb;
    color: #374151;
}

#chat-messages {
    display: flex;
    flex-direction: column;
}
</style>

<script>
// Generate a unique session ID for this user
const sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

let selectedText = '';

// DOM elements
const chatbotToggle = document.getElementById('chatbot-toggle');
const chatbotInterface = document.getElementById('chatbot-interface');
const chatbotClose = document.getElementById('chatbot-close');
const chatMessages = document.getElementById('chat-messages');
const chatInput = document.getElementById('chat-input');
const chatSend = document.getElementById('chat-send');
const selectedTextTooltip = document.getElementById('selected-text-tooltip');

// Toggle chat interface
chatbotToggle.addEventListener('click', () => {
    chatbotInterface.style.display = chatbotInterface.style.display === 'none' ? 'flex' : 'none';
});

// Close chat interface
chatbotClose.addEventListener('click', () => {
    chatbotInterface.style.display = 'none';
});

// Send message on button click
chatSend.addEventListener('click', sendMessage);

// Send message on Enter key
chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        sendMessage();
    }
});

// Function to send message to backend
async function sendMessage() {
    const message = chatInput.value.trim();
    if (!message) return;

    // Add user message to UI
    addMessage(message, 'user');
    chatInput.value = '';

    try {
        // Show typing indicator
        addTypingIndicator();

        // Prepare the request
        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                session_id: sessionId,
                message: message
            })
        });

        const data = await response.json();

        // Remove typing indicator
        removeTypingIndicator();

        if (response.ok) {
            // Add bot response to UI
            addMessage(data.response, 'bot');
        } else {
            addMessage('Sorry, I encountered an error. Please try again.', 'bot');
        }
    } catch (error) {
        removeTypingIndicator();
        addMessage('Sorry, I encountered an error. Please try again.', 'bot');
        console.error('Error:', error);
    }
}

// Function to add message to chat
function addMessage(text, sender) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}-message`;

    const messageP = document.createElement('p');
    messageP.textContent = text;

    messageDiv.appendChild(messageP);
    chatMessages.appendChild(messageDiv);

    // Scroll to bottom
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Function to add typing indicator
function addTypingIndicator() {
    const typingDiv = document.createElement('div');
    typingDiv.className = 'message bot-message';
    typingDiv.id = 'typing-indicator';

    const typingP = document.createElement('p');
    typingP.textContent = 'Typing...';
    typingP.style.color = '#9ca3af';

    typingDiv.appendChild(typingP);
    chatMessages.appendChild(typingDiv);

    // Scroll to bottom
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Function to remove typing indicator
function removeTypingIndicator() {
    const typingIndicator = document.getElementById('typing-indicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}

// Text selection functionality
document.addEventListener('mouseup', handleTextSelection);
document.addEventListener('touchend', handleTextSelection);

function handleTextSelection() {
    const selection = window.getSelection();
    if (selection.toString().trim() !== '') {
        selectedText = selection.toString().trim();

        if (selectedText.length > 0 && selectedText.length < 1000) { // Reasonable length check
            const range = selection.getRangeAt(0);
            const rect = range.getBoundingClientRect();

            // Position tooltip near the selection
            selectedTextTooltip.style.display = 'block';
            selectedTextTooltip.style.left = (rect.left + window.scrollX) + 'px';
            selectedTextTooltip.style.top = (rect.top + window.scrollY - 40) + 'px';

            // Add click event to tooltip
            selectedTextTooltip.onclick = function() {
                // Send selected text to backend for context
                sendSelectedText(selectedText);

                // Hide tooltip
                selectedTextTooltip.style.display = 'none';

                // Show chat interface if hidden
                chatbotInterface.style.display = 'flex';

                // Focus on input and suggest asking about the selected text
                chatInput.focus();
                chatInput.placeholder = `Ask about: ${selectedText.substring(0, 30)}...`;
            };
        }
    } else {
        selectedTextTooltip.style.display = 'none';
    }
}

// Function to send selected text to backend for context
async function sendSelectedText(text) {
    try {
        await fetch('/api/select-text', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                session_id: sessionId,
                selected_text: text
            })
        });
    } catch (error) {
        console.error('Error sending selected text:', error);
    }
}

// Hide tooltip when clicking elsewhere
document.addEventListener('click', function(event) {
    if (!selectedTextTooltip.contains(event.target)) {
        selectedTextTooltip.style.display = 'none';
    }
});
</script>